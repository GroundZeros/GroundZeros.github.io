é’ˆå¯¹è®¢å•ä¸‹å•åˆ°æ‰£å‡åº“å­˜è¿™ä¸€å…¸å‹åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå•†åœºé¡¹ç›®æ‹†åˆ†æ—¶ä¸ºäº†æ–¹ä¾¿ç›´æ¥é‡‡ç”¨äº†RabbitMQæ¶ˆæ¯é˜Ÿåˆ—è½®è¯¢ç›‘å¬æœ¬åœ°æ¶ˆæ¯è¡¨ã€‚ä½†æ˜¯åæ¥è€ƒè™‘åˆ°è¿™ç§å¼‚æ­¥æ“ä½œå†é«˜å¹¶å‘ä¸‹å¾ˆå¯èƒ½å¯¼è‡´å¤§é‡çš„å¤±è´¥è®¢å•ï¼Œå› ä¸ºåº“å­˜æ‰£å‡æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨è½®è¯¢é—´éš”æœŸé—´å¾ˆå¯èƒ½æ¶Œå…¥å¤§é‡è®¢å•ï¼Œæ­¤æ—¶æœªæ‰£å‡åº“å­˜ä¼šå…è®¸äº‹åŠ¡è¡¨å­˜å‚¨å¤§é‡æ— æ³•å®Œæˆçš„è®¢å•ã€‚

æ„Ÿè§‰æ¶ˆæ¯é˜Ÿåˆ—è¿™ç§è§£å†³æ–¹æ³•é€‚ç”¨äºå¯¹ç›¸åº”ä½¿ç”¨æ–¹å“åº”è¦æ±‚ä¸é«˜çš„æƒ…å†µï¼Œæ¯”å¦‚è½¬è´¦ã€ç§¯åˆ†ä¸šåŠ¡ï¼Œåœ¨é«˜å¹¶å‘çš„è®¢å•æœåŠ¡ä¸‹ä¸å¤ªåˆé€‚ï¼Œå› æ­¤è€ƒè™‘æ”¹ç”¨Seataæ¡†æ¶å®Œæˆï¼Œå®ç°æ•°æ®åº“å±‚é¢çš„å¼ºä¸€è‡´æ€§ã€‚

# é«˜å¯ç”¨é›†ç¾¤ç‰ˆæœ¬éƒ¨ç½²

Seataçš„é«˜å¯ç”¨ä¾èµ–äºæ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒå’Œæ•°æ®åº“æ¥å®ç°ï¼›å› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹ç›¸å…³çš„é…ç½®ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥nacoså’ŒMySQLä¸ºä¾‹å­ï¼ŒSeata-Serverä½¿ç”¨æ³¨å†Œä¸­å¿ƒè¿›è¡Œé›†ç¾¤é—´çš„é€šä¿¡ï¼ŒåŒæ—¶å°†äº‹åŠ¡æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­è®©æ•´ä¸ªé›†ç¾¤ç»Ÿä¸€ä½¿ç”¨äº‹åŠ¡ä¿¡æ¯ã€‚

## Nacosåˆ›å»ºç©ºé—´

æœåŠ¡å™¨ä¸Šçš„Nacoså·²ç»éƒ¨ç½²å¥½äº†ï¼Œåˆ›å»ºä¸€ä¸ªSeatå‘½åç©ºé—´ï¼Œä¸‹é¢éœ€è¦ç”¨åˆ°ç”Ÿæˆçš„Id

![image-20210901135434002](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011354049.png)

## åˆ›å»ºServerç«¯æ•°æ®åº“

æ‰€æœ‰éœ€è¦çš„æ•°æ®åº“å»ºè¡¨è¯­å¥å¯ä»¥åœ¨seata-server/confä¸‹çš„ReadMe.mdä¸­æ‰¾åˆ°ï¼Œå› ä¸ºæ˜¯é˜¿é‡Œå·´å·´å¼€å‘ï¼Œç”šè‡³æœ‰ä¸­æ–‡ç‰ˆæœ¬ã€‚è¿™é‡Œå•ç‹¬ä¸ºæœåŠ¡ç«¯åˆ›å»ºSeataæ•°æ®åº“

![image-20210901140849793](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011408824.png)

## ä¿®æ”¹ç›¸å…³é…ç½®æ–‡ä»¶

- ä¿®æ”¹file.confæ–‡ä»¶

```shell
cd /seata-server-1.4.2/conf
cp file.conf file.conf.bak
vim file.conf
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011416452.png)

- ä¿®æ”¹**registry.conf**æ–‡ä»¶

```shell
cp registry.conf registry.conf.bak
vim registry.conf
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011416321.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011418469.png)

- å¯åŠ¨Seata-server

```shell
cd /usr/seata-server-1.4.2/bin
chmod u+x seata-server.sh
./seata-server.sh  

#åå°å¯åŠ¨
nohup ./seata-server.sh -h å…¬ç½‘ip -p 8091 >log.out 2>1 &
```

> è¿™é‡Œä¸æŒ‡å®šIPä¼šåœ¨nacosé‡Œæ³¨å†Œä¸ºå†…ç½‘IPï¼ŒæœåŠ¡å™¨éƒ¨ç½²seataï¼Œæœ¬åœ°è°ƒè¯•æ˜¯é“¾æ¥ä¸ä¸Šçš„ï¼ï¼ï¼

å¯åŠ¨æˆåŠŸåï¼Œç¨ç­‰å°±å¯ä»¥çœ‹åˆ°nacosä¸­æ³¨å†Œçš„æœåŠ¡

![image-20210901142606746](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011426800.png)

- ä¿®æ”¹config.txt(è¿™ä¸ªconfigåœ¨æºç seata-1.4.2ä¸‹ï¼Œä¸ä¸Šé¢seata-server-1.4.2åœ¨ä¸åŒæ–‡ä»¶å¤¹)

  > è¿™ä¸€æ­¥å…¶å®å’Œfile.confæœ‰äº›é‡å¤ï¼Œéƒ½æ˜¯åœ¨ä¿®æ”¹æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ï¼Œåªæ˜¯åœ¨registry.confä¸­configæ”¹ä¸ºä»nacosè·å–ï¼Œå› æ­¤è¦æŠŠé…ç½®æ–‡ä»¶å‘é€åˆ°nacosä¸­ï¼Œä»¥åå¯åŠ¨ä¼šä»nacosä¸­è¯»å–é…ç½®ï¼Œä¹Ÿæ–¹ä¾¿ä¿®æ”¹ã€‚

```shell
cd /usr/seata-1.4.2/script/config-center
cp config.txt config.txt.bak
vim config.txt
```

![image-20210902131316998](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109021313070.png)

> Seata Serverç«¯å­˜å‚¨æ¨¡å¼ï¼ˆstore.modeï¼‰ç°æœ‰fileã€dbä¸¤ç§ï¼ˆæœ¬ç³»åˆ—ç”¨çš„æ˜¯fileæ¨¡å¼ï¼Œä½¿ç”¨dbæ¨¡å¼å¯ä»¥å‚ç…§å®˜ç½‘é…ç½®[http://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html](https://link.zhihu.com/?target=http%3A//seata.io/zh-cn/docs/ops/deploy-guide-beginner.html)ï¼‰ï¼Œ ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š
>
> - fileæ¨¡å¼ä¸ºå•æœºæ¨¡å¼ï¼Œå…¨å±€äº‹åŠ¡ä¼šè¯ä¿¡æ¯å†…å­˜ä¸­è¯»å†™å¹¶æŒä¹…åŒ–æœ¬åœ°æ–‡ä»¶root.dataï¼Œæ€§èƒ½è¾ƒé«˜;
> - dbæ¨¡å¼ä¸ºé«˜å¯ç”¨æ¨¡å¼ï¼Œå…¨å±€äº‹åŠ¡ä¼šè¯ä¿¡æ¯é€šè¿‡dbå…±äº«ï¼Œç›¸åº”æ€§èƒ½å·®äº›ã€‚

ä¿å­˜ä¹‹åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```shell
cd /usr/seata-1.4.2/script/config-center/nacos
sh nacos-config.sh -h IPåœ°å€ -p 8848 -g SEATA_GROUP -t ç©ºé—´å‘½åID -u nacos -w nacos
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011436841.png)

æ‰“å¼€nacosæŸ¥çœ‹é…ç½®ç”Ÿæ•ˆ

![image-20210901143750934](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109011437044.png)

# SpringBootæ•´åˆ

è¿™é‡ŒSeataæ­å»ºåœ¨æœåŠ¡ç«¯å¹¶ä¸”å·²ç»åœ¨æ³¨å†Œåˆ°nacosä¸­äº†ï¼Œåªéœ€è¦åœ¨å®¢æˆ·ç«¯ï¼ˆå¾®æœåŠ¡ï¼‰å¼•å…¥ä¾èµ–ï¼Œç¼–å†™é…ç½®ï¼Œå¹¶ä¸”åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­åˆ›æ·undo_logè¡¨å³å¯ã€‚

æ­å»ºè¿‡ç¨‹æ–­æ–­ç»­ç»­èŠ±äº†ä¸‰å¤©ï¼Œè®°å½•ä¸€ä¸‹æœ€ç»ˆæ­£ç¡®ç‰ˆæœ¬ï¼Œå‡ºç°çš„é”™è¯¯è®°å½•åœ¨æœ€åã€‚

ä¾èµ–ï¼š

```xml
<dependency>
    <!--ä¸æœåŠ¡å™¨ç‰ˆæœ¬å¯¹åº”-->
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>1.4.2</version>  
</dependency>

<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <exclusion>
            <groupId>io.seata</groupId>
            <artifactId>seata-spring-boot-starter</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

é…ç½®æ–‡ä»¶ï¼š

```yaml
seata:
  tx-service-group: my_test_tx_group  #äº‹åŠ¡ç»„åç§°
  registry:
    type: nacos
    nacos:
      namespace: 45a086a9-24eb-454d-ab7a-d1d0570efb0b
      server-addr: ip:8848  #nacosåœ°å€
      username: *****
      password: *****
      group: SEATA_GROUP
```

æœ€åundo_logè¡¨åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªä¸šåŠ¡æ•°æ®åº“ï¼Œéƒ½éœ€è¦å»ºè¡¨ã€‚

æ­å»ºå®Œæˆåï¼Œåªéœ€åœ¨ä¸šåŠ¡æ–¹æ³•ä¸Šæ·»åŠ @GlobalTransactionalæ³¨è§£å³å¯å®Œæˆåˆ†å¸ƒå¼äº‹åŠ¡ã€‚ï¼ˆç”¨èµ·æ¥ç®€å•ï¼Œæ­å»ºæ­¥æ­¥æ˜¯å‘å•Š

![image-20210903162626318](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031626366.png)

åœ¨è®¢å•ç”ŸæˆæœåŠ¡ä¸­æ·»åŠ æ³¨è§£ï¼Œå¹¶å¦‚ä¸‹æ·»åŠ ä¸€ä¸ªby zeroé”™è¯¯ï¼Œæµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡

![image-20210903162733504](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031627542.png)

æµ‹è¯•è®¢å•æ¥å£ï¼Œå½“ç„¶ä¼šå¤±è´¥ï¼Œæ­¤æ—¶ï¼Œæ§åˆ¶å°è¿”å›é”™è¯¯ä¿¡æ¯

![image-20210903163202188](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031632244.png)

è¿™ä¸é‡è¦ï¼Œæˆ‘ä»¬æ¥çœ‹Seatçš„ç»™æˆ‘ä»¬è¿”å›çš„ä¿¡æ¯ï¼Œé¦–å…ˆæ˜¯è®¢å•æœåŠ¡ï¼š

![image-20210903164003606](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031640675.png)

å¯ä»¥çœ‹åˆ°æœ‰å„ä¸ªè¡¨çš„Rollcackedä¿¡æ¯

åœ¨å•†å“æœåŠ¡ä¸­ä¹Ÿæœ‰å¯¹åº”å•ä¸ªå›æ»šä¿¡æ¯ï¼š

![image-20210903164437852](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031644887.png)

è¡¨ä¸­æ•°æ®è‡ªç„¶ä¹Ÿæ˜¯æ²¡é—®é¢˜ã€‚





# æ•´åˆä¸­å‡ºç°çš„å„ç§é—®é¢˜

![image-20210902131800486](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109021318543.png)

>  no available service found in cluster 'default', please make sure registry config correct and keep your seata server running

åœ¨defaulté›†ç¾¤ä¸Šæ‰¾ä¸åˆ°å¯ç”¨æœåŠ¡ï¼Œè§‚å¯Ÿåˆ°å…¶ä»–æœåŠ¡æ³¨å†Œä¸Šå»çš„æ—¶å€™é›†ç¾¤åç§°å¦‚ä¸‹

![image-20210903165212976](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031652020.png)

å¯èƒ½æ˜¯å¤§å°å†™å¼•èµ·çš„é”™è¯¯

åœ¨nacosé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹å¯¹åº”äº‹åŠ¡ç»„ï¼ˆgroupï¼‰çš„å€¼ï¼ˆä»£è¡¨seate-serveræ‰€åœ¨é›†ç¾¤åç§°ï¼‰ä¸ºå¤§å†™ï¼Œé‡æ–°å¯åŠ¨

> å…³äºäº‹åŠ¡åˆ†ç»„çš„ä»‹ç»å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://seata.io/zh-cn/docs/user/txgroup/transaction-group.html

ä»ç„¶é”™è¯¯ï¼Œä¸Šç½‘æŸ¥é˜…åæ„Ÿè§‰å‡ºç°è¿™ä¸ªé—®é¢˜å¯èƒ½æ˜¯pomä¾èµ–ç‰ˆæœ¬é—®é¢˜ï¼Œå®¢æˆ·ç«¯ä¾èµ–éœ€è¦å’ŒæœåŠ¡ç«¯ä¸€è‡´ï¼Œæ­¤å¤„æœåŠ¡ç«¯æ˜¯1.4ç‰ˆæœ¬ï¼Œä¾æ®å®˜ç½‘å»ºè®®ä½¿ç”¨spring-cloud-starter-alibaba-seataæ›´æ”¹ä¾èµ–å¦‚ä¸‹ï¼Œå…¶å†…éƒ¨å·²ç»å®ç°xidä¼ é€’ã€åˆå§‹åŒ–GlobalTransactionScannerç­‰ã€‚

```xml
<dependency>
    <!--æ·»åŠ ä¸æœåŠ¡ç«¯å¯¹åº”ç‰ˆæœ¬-->
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>1.4.2</version>
</dependency>
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç§»é™¤å†…ç½®ç‰ˆæœ¬-->
        <exclusion>
            <groupId>io.seata</groupId>
            <artifactId>seata-spring-boot-starter</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

ç„¶åè¿˜æœ‰ä¸€ä¸ªå‘ï¼Œè®°å¾—ä¿®æ”¹æœåŠ¡ç«¯çš„å¯åŠ¨å‚æ•°ä¸ºå…¬ç½‘IPï¼Œè¿™æ ·æ‰èƒ½åœ¨nacosä¸Šæ‹¿åˆ°æ­£ç¡®åœ°å€ï¼Œå¦‚æœæ˜¯å†…ç½‘æ­å»ºå°±æ— æ‰€è°“äº†ã€‚

ç»ˆäºè¿æ¥ä¸Šäº†ï¼Œæ­å»ºè¿‡ç¨‹ç¡®å®æœ‰ç‚¹ç¹çï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡æœ‰æ›´æ–°ã€‚

![image-20210903165815378](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031658425.png)

è¿æ¥æ²¡é”™è¯¯ï¼Œç„¶è€Œæµ‹è¯•çš„æ—¶å€™ä¹Ÿ**çœ‹ä¼¼**ä¸€åˆ‡æ­£å¸¸ï¼Œç„¶è€Œçœ‹æ•°æ®åº“å†…å®¹å°±çŸ¥é“ï¼Œseatå¹¶æ²¡æœ‰èµ·ä½œç”¨ã€‚

è‹¦æ¼äº†ä¸€ä¸ªä¸‹åˆï¼Œç»ˆäºåœ¨ä¸€ç¯‡åšå®¢ä¸­å‘ç°é—®é¢˜ï¼Œä¸€å¼ å›¾è§£å†³é—®é¢˜ğŸ‘‡ï¼Œå¯»æ‰¾è¿™ä¸ªæ¨¡æ¿ç±»æ‰“æ–­ç‚¹æµ‹è¯•ï¼ŒåŸæ¥æ˜¯æ²¡æœ‰ä»£ç†æ•°æ®æºã€‚

![img](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/202109031335409.png)

å¦‚æœå¼•ç”¨äº†spring-cloud-starter-alibaba-seataï¼Œæ•°æ®æºä»£ç†å¯ä»¥é€šè¿‡å¯åŠ¨ç±»çš„@EnableAutoDataSourceProxyè‡ªåŠ¨ä»£ç†ï¼ˆå®˜æ–¹æ–‡æ¡£æœ‰è¯´ï¼Œä½†ç½‘ä¸Šå¤§éƒ¨åˆ†èµ„æ–™éƒ½æ²¡æœ‰ä»‹ç»ï¼‰ã€‚

è§£å†³å®Œä¸Šè¿°é—®é¢˜ï¼Œç»ˆäºæˆåŠŸäº†ã€‚





å‚è€ƒï¼š[åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¿™ä¸€ç¯‡å°±å¤Ÿäº†](https://xiaomi-info.github.io/2020/01/02/distributed-transaction/)

[åˆ†å¸ƒå¼æœåŠ¡åŒ–ç³»ç»Ÿä¸€è‡´æ€§çš„â€œæœ€ä½³å®å¹²â€](https://mp.weixin.qq.com/s/khAwfJvWcwgbAYbBHbU8aQ)

