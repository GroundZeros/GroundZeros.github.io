---
title: Jenkins部署
tag： Jenkins 敏捷开发
author: 糖果炒蛋
---



首先安装git

## 离线方式安装git

### 下载git

下载git-2.32.0.tar.gz至目录/usr/git/下，并解压

```shell
tar -vxf /usr/git/git-2.32.0.tar.gz
cd /usr/git/git-2.32.0
```

![image-20210709134552887](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163748.png)

### 编译&&安装

```shell
./configure --prefix=/usr/local/git #安装目录
make
make install
```

![image-20210709134810440](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163752.png)

### 环境配置

```shell
# 编辑profile文件
vim /etc/profile
# 在porfile最后一行加上 
export PATH=$PATH:/usr/local/git/bin
# 生效配置
source /etc/profile
```

验证安装

![image-20210709135559090](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163757.png)

## 离线方式安装maven

下载maven3.8.1至目录/usr/local/

解压至/usr/local/maven目录安装完成

```shell
tar -xf apache-maven-3.5.4-bin.tar.gz 
mv apache-maven-3.5.4 /usr/local/maven
ln -s /usr/local/maven/bin/mvn  /usr/bin/mvn　　　　# 与jenkins联合使用时，jenkins会到/usr/bin/下找mvn命令，如果没有回报错
```

![image-20210709165911269](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163800.png)

### 环境配置

```shell
# 编辑profile文件
vim /etc/profile
# 在porfile最后一行加上 
export MAVEN_HOME=/usr/local/maven
export PATH=$MAVEN_HOME/bin:$PATH
# 生效配置
source /etc/profile
```

测试mvn命令

![image-20210709170004005](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163804.png)

### 配置镜像

![image-20210709171702972](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163808.png)

```xml
<mirror>
  <id>aliyunmaven</id>
  <mirrorOf>*</mirrorOf>
  <name>阿里云公共仓库</name>
  <url>https://maven.aliyun.com/repository/public</url>
</mirror>
```

## 配置Ngnix

配置新的ngnix.conf

备份原配置为nginx_bak.conf在原文件夹。

## 版本

官网下载Jenkins 2.289.2LTS至目录/usr/local/下

![image-20210709140614189](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163812.png)

在该目录下运行Jenkins

```shell
java -jar jenkins.war
```

浏览器访问http://172.16.70.200:8080

> 用户名：admin
>
> 密码：123456

进入界面

![image-20210709141618138](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163817.png)

## SSH密钥配置

首先在服务端生成密钥

```shell
ssh-keygen -t rsa -C "Jenkins210709"
```

进入Jenkins管理页面的系统管理->Manage Cregentials->添加凭据，类型选择SSH Username with private key

![image-20210709142646573](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163821.png)

在Private Key的Enter directly中填入公钥内容，

**在gitlab中同上，填入公钥内容，用于服务器拉取代码。**

## 新建任务

在Jenkins管理页面主页点击新建任务：

![image-20210709143309052](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163824.png)

选择自由风格项目

在源码管理中选择Git，Repository URL输入GitLab地址，Credentials选择刚刚添加的公钥凭证，选择分支，保存即可。

![image-20210709143423211](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163828.png)

在新增中选择“检出到子目录”选项，填写仓库本地子目录

> /usr/local/lyt-business-cloud

![image-20210713170555483](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163832.png)

在构建的第一栏选择添加“执行Shell”，填写

```shell
#!/bin/bash
cd /usr/local/lyt-business-cloud
git submodule update --init --recursive
git submodule update --remote
```

在本地仓库更新公共模块

## 自动部署配置

在项目配置中的构建选择“调用顶层Maven目标”，目标统一填写

```shell
clean install -Dmaven.test.skip=true #先清理后打包，不执行测试用例，也不编译测试用例类
```

![image-20210713170728159](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163840.png)

Pom分别填写本地仓库地址下对应的pom文件

>/usr/local/lyt-business-cloud/business-service/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-face/app-face-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-keyunit/app-keyunit-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-log/app-log-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-system/app-system-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-vehicle/app-vehicle-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-zdr/app-zdr-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-mainweb/app-mainweb-web/pom.xml
>
>/usr/local/lyt-business-cloud/business-web/app/app-socialaspect/app-socialaspect-web/pom.xml

共9个maven构建步骤完成后，在最后添加一个“执行Shell”

```shell
#!/bin/bash
cp /usr/local/lyt-business-cloud/business-service/app/app-face/target/app-face-1.0.0.jar /usr/local/business/app-face/app-face.jar
cp /usr/local/lyt-business-cloud/business-service/app/app-keyunit/target/app-keyunit-1.0.0.jar /usr/local/business/app-keyunit/app-keyunit.jar
cp /usr/local/lyt-business-cloud/business-service/app/app-log/target/app-log-1.0.0.jar /usr/local/business/app-log/app-log.jar
cp /usr/local/lyt-business-cloud/business-service/app/app-system/target/app-system-1.0.0.jar /usr/local/business/app-system/app-system.jar
cp /usr/local/lyt-business-cloud/business-service/app/app-vehicle/target/app-vehicle-1.0.0.jar /usr/local/business/app-vehicle/app-vehicle.jar
cp /usr/local/lyt-business-cloud/business-service/app/app-zdr/target/app-zdr-1.0.0.jar /usr/local/business/app-zdr/app-zdr.jar
cp /usr/local/lyt-business-cloud/business-service/daemon/target/daemon-1.0.0.jar /usr/local/business/daemon/daemon.jar
cp /usr/local/lyt-business-cloud/business-service/scheduleJob/target/scheduleJob-1.0.0.jar /usr/local/business/scheduleJob/scheduleJob.jar

cp /usr/local/lyt-business-cloud/business-web/app/app-face/app-face-web/target/app-face-web-1.0.jar /usr/local/business/static/app-face/app-face-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-keyunit/app-keyunit-web/target/app-keyunit-web-1.0.jar /usr/local/business/static/app-keyunit/app-keyunit-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-log/app-log-web/target/app-log-web-1.0.jar /usr/local/business/static/app-log/app-log-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-system/app-system-web/target/app-system-web-1.0.0.jar /usr/local/business/static/app-system/app-system-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-vehicle/app-vehicle-web/target/app-vehicle-web-1.0.0.jar /usr/local/business/static/app-vehicle/app-vehicle-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-zdr/app-zdr-web/target/app-zdr-web-1.0.0.jar /usr/local/business/static/app-zdr/app-zdr-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-mainweb/app-mainweb-web/target/app-mainweb-web-1.0.0.jar /usr/local/business/static/app-mainweb/app-mainweb-web.jar
cp /usr/local/lyt-business-cloud/business-web/app/app-socialaspect/app-socialaspect-web/target/app-socialaspect-web-1.0.0.jar /usr/local/business/static/app-socialaspect/app-socialaspect-web.jar



cd /usr/local/business
source shutdown-business.sh

cd /usr/local/business
#改变BUILD_ID防止jenkins构建结束后杀掉子进程
OLD_BUILD_ID=$BUILD_ID
echo $OLD_BUILD_ID
BUILD_ID=dontKillMe
source startup-business.sh
#改回原来的BUILD_ID值
BUILD_ID=$OLD_BUILD_ID
echo $BUILD_ID
```

将本地仓库打包的jar文件复制到对应的部署文件夹/usr/local/business下，先关闭服务，再执行启动脚本。



点击立即构建启动项目，生成构建历史

![image-20210709144259409](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163845.png)

在构建历史的控制台输出可以查看信息

![image-20210714103650228](https://cdn.jsdelivr.net/gh/GroundZeros/ImageHost@main/images/20210715163849.png)
